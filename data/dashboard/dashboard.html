<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=0.5">
        <title>Dashboard</title>
        <link rel="stylesheet" href="dashboard-style.css">
        <!-- Chart.js (online) -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    </head>

    
    <body>
        <nav id="main-nav">
            <img src="./images/control-black.png" alt="control" class="control-button1">

        </nav>



        <div id="control-menu">
                
            <nav id="control-nav">
                <img src="./images/control-black.png" alt="control" class="control-button2">

                <label class="switch" id="top-darkmode-switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </nav>

            <div class="control-content">

                <div class="control-header">
                    <h1>Controls</h1>
                </div>

                <!-- DOOR SECTION -->
                <div class="control-section">
                    <h3>Door</h3>
            
                    <div class="control-row">
                        <span>Main Door</span>

                        <div class="toggle-container">
                            <span>CLOSE</span>
                            <label class="switch">
                                <input type="checkbox" id="door-control">
                                <span class="slider"></span>
                            </label>
                            <span>OPEN</span>
                        </div>
                    </div>
                </div>

                <!-- LIGHTS SECTION -->
                <div class="control-section">
                    <h3>Lights</h3>

                    <div class="control-row">
                        <span>Room 1</span>
                        <div class="toggle-container">
                            <span>OFF</span>
                            <label class="switch">
                                <input type="checkbox" id="room1Control">
                                <span class="slider"></span>
                            </label>
                            <span>ON</span>
                        </div>
                    </div>

                    <div class="control-row">
                        <span>Room 2</span>
                        <div class="toggle-container">
                            <span>OFF</span>
                            <label class="switch">
                                <input type="checkbox" id="room2Control">
                                <span class="slider"></span>
                            </label>
                            <span>ON</span>
                        </div>
                    </div>
                </div>

        
                <div class="control-section">
                    <h3>Buzzer</h3>

                    <div class="control-row">
                        <span>Trigger Alarm</span>
                        <div class="toggle-container">
                            <span>OFF</span>
                            <label class="switch">
                                <input type="checkbox" id="trigger-alarm">
                                <span class="slider"></span>
                            </label>
                            <span>ON</span>
                        </div>
                    </div>
                </div>

            </div> 
        </div> 




            

            
            <div id="sensor-readings">  
                
                

                <div class="column">
                    <div class="column-header">
                        <h2>Sensor Status</h2>
                    </div>

                    <table>
                        <tr>
                            <td>Door</td>
                            <td id="door-status"></td>
                        </tr>

                        <tr id="room1">
                            <td>Room 1 Lights</td>
                            <td id="room1State"></td>
                        </tr>

                        <tr>
                            <td>Room 2 Lights</td>
                           <td id="room2State"></td>
                        </tr>
                    
                        <tr>
                            <td>Capacitive Sensor</td>
                            <td id="capacitive-status"></td>
                        </tr>

                        <tr>
                            <td>Buzzer</td>
                            <td id="buzzer-status"></td>
                        </tr>
                        
                         <tr>
                            <td>Sound Sensor</td>
                            <td id="soundSenStatus"></td>
                        </tr>

                        <tr>
                            <td>Ultrasonic Sensor</td>
                            <td id="ultrasonic-status"></td>
                        </tr>




                    </table>
                </div>

                <div class="column">
                    <div class="column-header">
                        <h2>Sensor Readings</h2>
                    </div>

                    <div id="sensor-readings-content">
                        <div class="parent-box">
                            <div class="box" sensor-data="temperature">
                                <div class="box-content">
                                    <img src="./images/temperature-red.png" alt="temperature-icon" id="temperature">
                                    <p id="temp-value"></p>
                                </div>
                                <p>Temperature</p>
                            </div>

                            <div class="box" sensor-data="humidity">
                                <div class="box-content"> 
                                    <img src="./images/humidity-dark.png" alt="humidity-icon" id="humidity">
                                    <p id="humid-value"></p>
                                </div>
                                <p>Humidity</p>
                            </div>
                        </div>


                        <div class="parent-box">
                            <div class="box" sensor-data="light">
                                <div class="box-content">
                                    <img src="./images/light-dark.png" alt="light-icon" id="light">
                                    <p id="light-value"></p>
                                </div>
                                <p>Light Intensity</p>

                            </div>

                            <div class="box" sensor-data="sound">
                                <div class="box-content">
                                    <img src="./images/sound-dark.png" alt="sound-icon" id="sound">
                                    <p id="sound-value"></p>
                                </div>
                                <p>Sound Value</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>




        <footer>
         

            <div class="footer-content">

                <div class="footer-logo">
                    <img src="./images/logo-black.png" alt="logo" id="footer-logo">
                    <p>Bahay ni Kuya: A Sensor Integrated<br> Home System</p>
                    <p class="footer-subtitle">Submitted in partial fulfillment of CPEN 85 & CPEN 101</p>
                     <p class="footer-subtitle">Cavite State University – Carmona Campus</p>
                </div>

                <div class="footer-column">
                    <p class="footer-title">Team Members:</p>
                </div>

                <div class="footer-column">
                    <p>Jannah Gaspar</p>
                    <p>Angelo Gripon Jr.</p>
                    <p>Jay Johnlie Galo</p>
                </div>

                <div class="footer-column">
                    <p>Yuan Ancheta</p>
                    <p>Marcus Miranda</p>
                </div>

                    <div class="footer-column">
                    <p>Shiena Rose Madridano</p>
                    <p>Genesis Baldonasa</p>
                </div>

            </div>

    

    
        </footer>

        <div id="alert-notification" class="alert"> 
            <div class="alert-content">
                <strong>⚠️ SECURITY ALERT</strong>
                <p>Multiple failed door attempts detected.</p>
                </div>
                <div class="alert-progress">
                <div class="alert-bar"></div>
            </div>
        </div>




        <script>
            const panel = document.getElementById("control-menu");
            const button1 = document.querySelector(".control-button1");
            const button2 = document.querySelector(".control-button2");

            // Function to get the current control menu width from CSS variable
            function getMenuWidth() {
            return getComputedStyle(document.documentElement).getPropertyValue('--control-menu-width') || '25%';
            }

            function openPanel() {
                panel.style.width = getMenuWidth();
                button2.style.transform = "rotate(270deg)";
                button1.style.transform = "rotate(270deg)";
            }

            function closePanel() {
                panel.style.width = "0";
                button2.style.transform = "rotate(0deg)";
                button1.style.transform = "rotate(0deg)"; // rotate back when closing
            }

            button1.addEventListener("click", (e) => {
                e.stopPropagation();
                if (panel.style.width === getMenuWidth()) {
                    closePanel();
                } else {
                    openPanel();
                }
            });

            // Toggle panel when button2 clicked
            button2.addEventListener("click", (e) => {
                e.stopPropagation();
                closePanel();
            });


            document.addEventListener("click", (e) => {
                if (!panel.contains(e.target) && panel.style.width === getMenuWidth()) {
                    panel.style.width = "0";
                    button2.style.transform = "rotate(0deg)";
                    button1.style.transform = "rotate(0deg)";
                }
            });
        </script>

        <script>
                let lastDHTSave = 0;
                async function updateDHT() {
                    try {
                        const response = await fetch('/sensor-data');
                        const data = await response.json();
                        
                        document.getElementById('temp-value').innerText = (data.temperature !== undefined ? data.temperature.toFixed(2) : '--') + ' C';
            

                        document.getElementById('humid-value').innerText = (data.humidity !== undefined ? data.humidity.toFixed(2) : '--') + ' %';
                        const now = Date.now();
                        if (now - lastDHTSave >= 10000) {
                            pushValue('temperature', data.temperature);
                            pushValue('humidity', data.humidity);
                            lastDHTSave = now;

                            if (chart) chart.update();
                        }
                        
                    } catch (error) {
                        console.error('Error fetching sensor data:', error);
                    }
                }

                async function updateSound() {
                    try {
                        const response = await fetch('/sound-data');
                        const data = await response.json();

                        document.getElementById('sound-value').innerText = (data.sound !== undefined ? data.sound : '--');
                        document.getElementById('soundSenStatus').innerText = data.clapDetected || '--';
                        pushValue('sound', Number(data.sound)); //for graph
                        if (chart) chart.update();

     

                    }
                    catch (error) {
                        console.error('Sound fetch error: ', error);

                    }
                }
                    setInterval(updateDHT, 2000); // Update every 2 seconds
                    updateDHT();
                    setInterval(updateSound, 200); // Update every 200 milliseconds
                    updateSound();


                
            
        </script>

        <script>

            async function updateLDR() {
                try {
                const response = await fetch('/ldr-data'); // call ESP32 endpoint
                const data = await response.json();

                // Update the <p id="light-value">
                document.getElementById('light-value').innerText = 
                (data.light !== undefined ? data.light : '--') + ' Lx';
                pushValue('light', data.light);
                if (chart) chart.update();



                } 
                catch (error) {
                    console.error('Error fetching LDR data:', error);
                }
               
            }
                updateLDR();
                setInterval(updateLDR, 200);

        </script>



        <!--
        <script>
            async function updateLEDStates() {
                try {
                    const response = await fetch('/led-status');
                    const data = await response.json();

                    // Update table cells
                    document.getElementById('room1State').innerText = data.ldr || '--';
                    document.getElementById('room2State').innerText = data.sound || '--';
                } 

                catch (error) {
                    console.error('Error fetching LED states:', error);
                }
            }

            // Update every 200ms
            setInterval(updateLEDStates, 200);
            updateLEDStates();
        </script> -->

        <script>
            async function updateLEDStates() {
            try {
                const response = await fetch('/led-status');
                const data = await response.json();

                // Get table cells
                const room1Cell = document.getElementById('room1State');
                const room2Cell = document.getElementById('room2State');

                // Update text
                room1Cell.innerText = data.ldr || '--';
                room2Cell.innerText = data.sound || '--';

                // Set color based on state
                room1Cell.style.color = data.ldr === 'ON' ? 'green' : 'red';
                room2Cell.style.color = data.sound === 'ON' ? 'green' : 'red';

                // Update checkboxes
                document.getElementById('room1Control').checked = data.ldr === 'ON';
                document.getElementById('room2Control').checked = data.sound === 'ON';

            } catch (error) {
                console.error('Error fetching LED states:', error);
            }
        }
                setInterval(updateLEDStates, 200);
                updateLEDStates();
        </script>


        <script>
        document.getElementById('room1Control').addEventListener('change', async () => {
            let state = document.getElementById('room1Control').checked ? 'on' : 'off';
            await fetch(`/room1?state=${state}`);
        });

        document.getElementById('room2Control').addEventListener('change', async () => {
            let state = document.getElementById('room2Control').checked ? 'on' : 'off';
            await fetch(`/room2?state=${state}`);
        });
        </script>



        <script>
             const doorControl = document.getElementById('door-control');
             //const doorStatus = document.getElementById('door-status');
            
             doorControl.addEventListener('change', async () => {
                let state = doorControl.checked ? 'open' : 'close';
                try {
                    const response = await fetch('/door?state=' + state);
                    if (!response.ok) throw new Error('Network response not ok');
                    console.log('Door command sent: ', state);
                } catch (error) {
                    console.error('Error sending door command:', error);


                }
                //doorStatus.innerText = state === 'open' ? 'OPEN' : 'CLOSED';
            });
            //doorStatus.innerText = doorControl.checked ? 'OPEN' : 'CLOSED';

        </script>

       
        <script>
            const doorStatus = document.getElementById('door-status');

            async function updateDoorStatus() {
                try {
                    const response = await fetch('/door-status');
                    const data = await response.json();
                    doorStatus.innerText = data.door;
                    doorStatus.style.color = data.door === 'OPEN' ? 'green' : 'red';
                } catch (error) {
                    console.error('Error fetching door status:', error);
                    doorStatus.innerText = '--';
                }
                
            }

            // Update every 500ms
         
            setInterval(updateDoorStatus, 500);
            updateDoorStatus();
            

        </script>


            <!-- Modal -->
        <div id="sensor-modal" class="modal hidden">
            <div class="modal-content">
                <span id="close-modal">&times;</span>
                <h2 id="modal-title">Sensor Data</h2>
                <div id="modal-graph">
                    <canvas id="sensorChart"></canvas>
                    
                </div>
            </div>
        </div>

        <script>
            const boxes = document.querySelectorAll('.box');
            const modal = document.getElementById('sensor-modal');
            const closeModal = document.getElementById('close-modal');
            const modalTitle = document.getElementById('modal-title');

            boxes.forEach(box => {
                box.addEventListener('click', () => {
                    const sensor = box.getAttribute('sensor-data');
                    modalTitle.innerText = sensor.charAt(0).toUpperCase() + sensor.slice(1) + " Data";
                    modal.classList.remove('hidden');
                    createChart(sensor);
                });
            });

            closeModal.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            //close modal when clicking outside content
            modal.addEventListener('click', (e) => {
                if(e.target === modal) modal.classList.add('hidden');
            });
        </script>

        <!--history buffer-->

        <script>
            const history = {
                temperature: [],
                humidity: [],
                light: [],
                sound: []
            };

            const MAX_POINTS = {
                temperature: 30, 
                humidity: 30,
                light: 50,
                sound: 50
            };

            function pushValue(sensor, value) {
                if (value === undefined || isNaN(value)) return;

                history[sensor].push({
                    x: new Date(),
                    y: value
                });

                if (history[sensor].length > MAX_POINTS[sensor]) {
                    history[sensor].shift();
                }
            }

            
        </script>

        <script>
            let chart;

            function createChart(sensor) {
                const ctx = document.getElementById('sensorChart').getContext('2d');

                if (chart) chart.destroy();
                const isDarkMode = document.body.classList.contains('dark-mode');

                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: sensor.toUpperCase(),
                            data: history[sensor],
                            borderWidth: 2,
                            tension: 0.3,
                            pointRadius: 2,
                            fill: false,
                            borderColor: isDarkMode ? 'white' : 'black', // line color
                            backgroundColor: isDarkMode ? 'white' : 'black', // point color
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: isDarkMode ? 'white' : 'black' // legend text color
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: sensor === 'temperature' || sensor === 'humidity' ? 'minute' : 'second'
                                },
                                ticks: {
                                    color: isDarkMode ? 'white' : 'black' // x-axis labels
                                },
                                grid: {
                                    color: isDarkMode ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)' // grid lines
                                }
                            },


                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: isDarkMode ? 'white' : 'black' // y-axis labels
                                },
                                grid: {
                                    drawTicks: true,
                                    color: isDarkMode ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)' // grid lines
                                }
                            }

                        }
                    }
                });
            }
</script>

    <script>

        const toggle = document.getElementById("darkModeToggle");

 
        if (localStorage.getItem("theme") === "dark") {
            document.body.classList.add("dark-mode");
            toggle.checked = true;
        }

        toggle.addEventListener("change", () => {
            if (toggle.checked) {
                document.body.classList.add("dark-mode");
                localStorage.setItem("theme", "dark");
            } else {
                document.body.classList.remove("dark-mode");
                localStorage.setItem("theme", "light");
            }
        });

     

    </script>

    <script>
    let lastAlarmTime = 0;

    async function checkAlarm() {
        try {
            const res = await fetch('/alarm-status');
            const data = await res.json();

            if (data.alarm && data.time !== lastAlarmTime) {
                lastAlarmTime = data.time;
                showAlert();
            }
        } catch (err) {
            console.error("Alarm check failed", err);
        }
    }

    function showAlert() {
        const alertBox = document.getElementById('alert-notification');
        const bar = alertBox.querySelector('.alert-bar');

        // reset animation
        bar.style.animation = 'none';       
        bar.offsetHeight;
        bar.style.animation = 'alertProgress 5s linear forwards';

        alertBox.classList.add('show');

        setTimeout(() => {
            alertBox.classList.remove('show');
        }, 5000);
    }
    setInterval(checkAlarm, 500);

    </script>

    <script>
        const alarmCheckbox = document.getElementById('trigger-alarm');

        alarmCheckbox.addEventListener('change', async () => {
            const state = alarmCheckbox.checked ? 'on' : 'off';
            try {
                await fetch(`/alarm-toggle?state=${state}`);
            } catch (err) {
                console.error("Failed to toggle alarm:", err);
            }
        });
    </script>

    <script>
        async function updateBuzzerStatus() {
            try {
                const response = await fetch('/buzzer-status');
                const data = await response.json();
                document.getElementById('buzzer-status').innerText = data.status;
                document.getElementById('buzzer-status').style.color = (data.status === "Active") ? "green" : "red";
            } catch (error) {
                console.error('Error fetching buzzer status:', error);
                document.getElementById('buzzer-status').innerText = "--";
                document.getElementById('buzzer-status').style.color = "black";
            }
        }

        // Update every 200ms
        setInterval(updateBuzzerStatus, 200);
        updateBuzzerStatus();
    </script>

    <script>
        async function updateUltrasonicStatus() {
            try {
                const response = await fetch('/ultrasonic-data');
                const data = await response.json();

                const statusCell = document.getElementById('ultrasonic-status');
                statusCell.innerText = data.status; // display "Object Detected!" or "No Object"
                statusCell.style.color = (data.status === "Object Detected!") ? "green" : "red";
            } catch (error) {
                console.error('Error fetching ultrasonic status:', error);
                const statusCell = document.getElementById('ultrasonic-status');
                statusCell.innerText = "--";
                statusCell.style.color = "black";
            }
        }

        // Update every 200ms
        setInterval(updateUltrasonicStatus, 200);
        updateUltrasonicStatus();
    </script>

    <script>
            async function updateTouchStatus() {
        try {
            const res = await fetch('/touch-status');
            const data = await res.json();

            const cell = document.getElementById('capacitive-status');

            let label = "IDLE";
            let color = "red";

            if (data.authorized) {
                label = "AUTHORIZED";
                color = "green";
            }
            else if (data.touch1 && data.touch2) {
                label = `Initializing...`;
                color = "orange";
            }

            else if (data.touch1 || data.touch2) {
                let activePad = data.touch1 ? "T1" : "T2";
                label = `Hold Both (${activePad})`;
                color = "orange";
            }

            

            cell.innerText = label;
            cell.style.color = color;

        } catch (err) {
            console.error("Touch status fetch failed:", err);
        }
    }

    setInterval(updateTouchStatus, 200);
    updateTouchStatus();

    </script>
















    </body>
</html>